<div class="create-election-container">
  <p-toast></p-toast>

  <p-card header="Crear Nueva Elección">
    <form [formGroup]="electionForm" (ngSubmit)="onSubmit()">

      <div class="field">
        <label for="title" class="block font-bold mb-2">Título</label>
        <input id="title" type="text" pInputText formControlName="title" class="w-full" />
        <small class="p-error block" *ngIf="electionForm.get('title')?.invalid && electionForm.get('title')?.touched">
          El título es requerido (5-100 caracteres)
        </small>
      </div>

      <div class="field mt-3">
        <label for="description" class="block font-bold mb-2">Descripción</label>
        <textarea id="description" pInputTextarea formControlName="description" class="w-full" rows="3"></textarea>
        <small class="p-error block" *ngIf="electionForm.get('description')?.invalid && electionForm.get('description')?.touched">
          La descripción es requerida (10-500 caracteres)
        </small>
      </div>

      <div class="formgrid grid mt-3">
        <div class="field col-12 md:col-6">
          <label for="startTime" class="block font-bold mb-2">Fecha de Inicio</label>
          <p-calendar inputId="startTime" formControlName="startTime" [showTime]="true" [showIcon]="true" styleClass="w-full"></p-calendar>
          <small class="p-error block" *ngIf="electionForm.get('startTime')?.invalid && electionForm.get('startTime')?.touched">
            Fecha de inicio requerida
          </small>
        </div>
        <div class="field col-12 md:col-6">
          <label for="endTime" class="block font-bold mb-2">Fecha de Fin</label>
          <p-calendar inputId="endTime" formControlName="endTime" [showTime]="true" [showIcon]="true" styleClass="w-full"></p-calendar>
          <small class="p-error block" *ngIf="electionForm.get('endTime')?.invalid && electionForm.get('endTime')?.touched">
            Fecha de fin requerida
          </small>
        </div>
      </div>

      <p-divider align="center">
        <span class="p-tag">Opciones de Voto</span>
      </p-divider>

      <div formArrayName="options">
        <div *ngFor="let option of options.controls; let i=index" [formGroupName]="i" class="option-item mb-3 p-3 border-1 surface-border border-round">
          <div class="flex justify-content-between align-items-center mb-2">
            <span class="font-bold">Opción {{i + 1}}</span>
            <button pButton icon="pi pi-trash" class="p-button-danger p-button-text p-button-sm"
                    (click)="removeOption(i)" [disabled]="options.length <= 2" type="button"></button>
          </div>

          <div class="field">
            <input type="text" pInputText formControlName="title" placeholder="Título de la opción" class="w-full mb-2" />
          </div>
          <div class="field">
            <input type="text" pInputText formControlName="description" placeholder="Descripción (opcional)" class="w-full" />
          </div>
        </div>
      </div>

      <div class="flex justify-content-center mt-3">
        <button pButton label="Añadir Opción" icon="pi pi-plus" class="p-button-outlined" (click)="addOption()" type="button"></button>
      </div>

      <div class="flex justify-content-end mt-5 gap-2">
        <button pButton label="Cancelar" class="p-button-secondary" routerLink="/admin" type="button"></button>
        <button pButton label="Crear Elección" icon="pi pi-check" class="p-button-success" type="submit" [loading]="loading"></button>
      </div>

    </form>
  </p-card>

  <p-dialog header="¡ATENCIÓN! Clave Privada Generada" [(visible)]="showPrivateKeyDialog" [modal]="true" [style]="{width: '50vw'}" [closable]="false">
    <div class="flex flex-column align-items-center">
        <i class="pi pi-exclamation-triangle text-yellow-500 text-5xl mb-3"></i>
        <p class="text-center font-bold text-xl mb-3">Guarde esta clave en un lugar seguro</p>
        <p class="text-center mb-4">
            Esta es la <strong>ÚNICA VEZ</strong> que se mostrará la clave privada.
            Sin ella, <strong>NO SE PODRÁ REALIZAR EL RECUENTO</strong> de los votos.
            El servidor NO guarda esta clave.
        </p>

        <textarea pInputTextarea [rows]="10" [cols]="60" [readonly]="true" class="w-full font-mono text-sm bg-gray-100 p-3">{{generatedPrivateKey}}</textarea>

        <div class="mt-4 w-full">
            <p-message severity="warn" text="Copie el contenido y guárdelo en un archivo seguro (ej. private_key.pem)"></p-message>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <button pButton icon="pi pi-check" (click)="closeDialog()" label="He guardado la clave" class="p-button-success"></button>
    </ng-template>
  </p-dialog>
</div>
